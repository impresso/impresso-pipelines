# UV Migration Guide

This project now supports **uv** as the primary dependency manager for faster installations and better performance, while maintaining full Poetry compatibility.

## What is uv?

[uv](https://github.com/astral-sh/uv) is an extremely fast Python package installer and resolver, written in Rust. It's 10-100x faster than pip and Poetry.

## Performance Comparison

| Task                     | Poetry   | uv     | Speedup           |
| ------------------------ | -------- | ------ | ----------------- |
| Lock dependencies        | ~10-30s  | ~1-2s  | **10-15x faster** |
| Install all dependencies | ~60-180s | ~8-30s | **3-6x faster**   |
| Run tests                | Same     | Same   | N/A               |

## Installation

### Install uv

```bash
# macOS/Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# Or with pip
pip install uv

# Or with Homebrew (macOS)
brew install uv
```

## Usage

### Quick Start

```bash
# Install all dependencies (including dev)
uv sync --extra all --extra dev

# Run tests
uv run pytest

# Run specific test suite
uv run pytest tests/ocrqa/
```

### Using Make (Recommended)

The Makefile automatically detects whether you have uv or Poetry installed:

```bash
# Install dependencies
make install-dev

# Run all tests (with JVM conflict handling)
make test

# Run specific tests
make test-ocrqa
make test-langident
make test-ldatopics

# Code quality
make lint
make format
make type-check
make qa
```

When you run `make help`, it will show which tool is being used:

```
Using tool: uv
```

### Direct uv Commands

```bash
# Install production dependencies only
uv sync --extra all

# Install with dev dependencies
uv sync --extra all --extra dev

# Update lock file
uv lock

# Run any Python command
uv run python -m impresso_pipelines.langident.langident_pipeline

# Run pytest with specific options
uv run pytest tests/ -v --log-cli-level=INFO

# Run linting
uv run flake8 impresso_pipelines/
uv run mypy impresso_pipelines/
```

## Migration from Poetry

You don't need to do anything! The project supports both tools:

1. **If you have uv installed**: It will be used automatically
2. **If you only have Poetry**: Everything works as before
3. **Both installed**: uv takes priority (it's faster)

### For CI/CD

The GitHub Actions workflow now uses uv by default for faster CI runs:

```yaml
- name: Set up uv
  uses: astral-sh/setup-uv@v3
  with:
    enable-cache: true
    cache-dependency-glob: "uv.lock"

- name: Install dependencies
  run: uv sync --extra all --extra dev

- name: Run tests
  run: uv run pytest
```

**Expected CI speedup**: 3-6x faster dependency installation!

## File Structure

- `pyproject.toml` - Contains both PEP 621 `[project]` section (for uv) and `[tool.poetry]` (for Poetry)
- `uv.lock` - Lock file generated by uv (committed to git)
- `poetry.lock` - Lock file for Poetry users (still supported)
- `.venv/` - Virtual environment (works with both tools)

## Troubleshooting

### uv not detected by Makefile

```bash
# Verify uv is in PATH
which uv

# If not found, reinstall
curl -LsSf https://astral.sh/uv/install.sh | sh

# Reload shell
source ~/.zshrc  # or ~/.bashrc
```

### Dependencies out of sync

```bash
# Regenerate lock file
uv lock

# Force reinstall
rm -rf .venv/
uv sync --extra all --extra dev
```

### Want to switch back to Poetry?

Simply remove uv from your PATH or uninstall it:

```bash
# Remove uv
rm -rf ~/.cargo/bin/uv

# Makefile will automatically fall back to Poetry
make help
# Output: Using tool: poetry
```

## Benefits of uv

✅ **3-6x faster CI/CD** - Reduced waiting time for test results  
✅ **Faster local development** - Quick dependency installation  
✅ **Better caching** - Smarter dependency resolution  
✅ **Drop-in replacement** - No changes needed to your workflow  
✅ **Cross-platform** - Works on macOS, Linux, Windows  
✅ **Modern tooling** - Built with Rust for maximum performance

## Compatibility

- ✅ Python 3.11, 3.12
- ✅ All existing extras: `all`, `langident`, `ocrqa`, `ldatopics`, `newsagencies`, `solrnormalization`
- ✅ All test suites pass identically with both tools
- ✅ JVM conflict handling works the same
- ✅ VS Code integration unchanged

## Learn More

- [uv Documentation](https://docs.astral.sh/uv/)
- [uv GitHub Repository](https://github.com/astral-sh/uv)
- [Why uv is fast](https://astral.sh/blog/uv)
